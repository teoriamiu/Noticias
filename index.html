<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diario Noticias, üåç </title>
  
  <!-- SEO -->
  <meta name="description" content="Sitio moderno con noticias actualizadas.">
  <meta name="keywords" content="Diario Noticias">
  <meta name="author" content="Agust√≠n D√≠az">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://diario-noticias.netlify.app/">
  
  <!-- SEO Redes Sociales -->
  <meta property="og:title" content="Diario Noticias">
  <meta property="og:description" content="Noticias al instante.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://via.placeholder.com/1200x630.png?text=Mi+Web+Integrada">
  
  <meta property="og:title" content="¬°El Super Alacr√°n Ha Llegado! ü¶Çüî•">
  <meta property="og:description" content="Descubre todo sobre el incre√≠ble Super Alacr√°n: su origen, poderes y la leyenda que lo rodea. ¬°Una criatura √©pica te espera!">
  <meta property="og:image" content="https://i.imgur.com/DApJ91v.jpeg">
  <meta property="og:url" content="https://diario-noticias.netlify.app/">
  <meta property="og:type" content="website">
  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="¬°El Super Alacr√°n Ha Llegado! ü¶Çüî•">
  <meta name="twitter:description" content="Descubre todo sobre el incre√≠ble Super Alacr√°n: su origen, poderes y la leyenda que lo rodea. ¬°Una criatura √©pica te espera!">
  <meta name="twitter:image" content="https://i.imgur.com/DApJ91v.jpeg">

  <style>
    :root { --g: 12px; }
    html,body { margin:0; padding:0; background:#fff; font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial; color:#111; }
    body { max-width:980px; margin:auto; padding:24px; }
    h1 { margin:0; font-size:22px; font-weight:600; }
    header { display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px; margin-bottom:18px; }
    input[type="search"]{padding:8px 10px;border:1px solid #ddd;border-radius:8px;font-size:14px;min-width:220px;}
    button{padding:8px 12px;border:0;border-radius:8px;background:#111;color:#fff;cursor:pointer;font-size:14px;}
    .cats{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;}
    .cats button{background:#fafafa;color:#111;border:1px solid #eee;padding:6px 10px;font-size:13px;border-radius:8px;cursor:pointer;}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:var(--g);}
    .card{border:1px solid #eee;border-radius:10px;padding:12px;background:#fff;display:flex;flex-direction:column;gap:8px;}
    .card img{width:100%;height:140px;object-fit:cover;border-radius:6px;}
    .title{font-weight:600;font-size:15px;}
    .meta{font-size:12px;color:#666;}
    #status{margin:14px 0;color:#444;}
    footer{margin-top:20px;font-size:13px;color:#666;}
    a{color:inherit;}
    .cat-active { background:#111;color:#fff;border-color:#111; }
  </style>
</head>

<body>
  <header>
    <h1>Noticias ‚Äî GNews</h1>
    <div style="display:flex;gap:8px;">
      <input id="q" type="search" placeholder="Buscar...">
      <button id="btnBuscar">Buscar</button>
    </div>
  </header>

  <div class="cats" id="cats"></div>
  <div id="status">Cargando...</div>
  <main><div id="list" class="grid"></div></main>
  <footer><span id="info">‚Äî</span></footer>

  <script>
    /********** CONFIG **********/
    const CATEGORIES = ["business","entertainment","general","health","science","sports","technology"];
    const CAT_LABELS = {
      business: "Negocios",
      entertainment: "Entretenimiento",
      general: "General",
      health: "Salud",
      science: "Ciencia",
      sports: "Deportes",
      technology: "Tecnolog√≠a"
    };
    const CLIENT_CACHE_TTL = 60 * 5; // segundos -> 5 minutos
    const DEBOUNCE_MS = 350;

    /********** HELPERS **********/
    function cacheSet(key, data, ttlSec = CLIENT_CACHE_TTL) {
      try {
        const obj = { t: Date.now(), ttl: ttlSec*1000, v: data };
        localStorage.setItem(key, JSON.stringify(obj));
      } catch (e) { /* ignore */ }
    }
    function cacheGet(key) {
      try {
        const s = localStorage.getItem(key);
        if (!s) return null;
        const obj = JSON.parse(s);
        if (Date.now() - obj.t > obj.ttl) { localStorage.removeItem(key); return null; }
        return obj.v;
      } catch (e) { return null; }
    }
    function debounce(fn, wait = DEBOUNCE_MS) {
      let t;
      return (...a) => { clearTimeout(t); t = setTimeout(()=>fn(...a), wait); };
    }

    /********** DOM **********/
    const qInput = document.getElementById("q");
    const btnBuscar = document.getElementById("btnBuscar");
    const cats = document.getElementById("cats");
    const status = document.getElementById("status");
    const list = document.getElementById("list");
    const info = document.getElementById("info");

    // render categories (labels in Spanish, but send english keys)
    let activeCat = "general";
    CATEGORIES.forEach(cat => {
      const b = document.createElement("button");
      b.textContent = CAT_LABELS[cat] || cat;
      b.dataset.cat = cat;
      b.onclick = () => {
        // visually mark active
        document.querySelectorAll('.cats button').forEach(x => x.classList.remove('cat-active'));
        b.classList.add('cat-active');
        activeCat = cat;
        load(cat);
      };
      if (cat === activeCat) b.classList.add('cat-active');
      cats.appendChild(b);
    });

    /********** NETWORK (client cache + fetch) **********/
    async function fetchFromServer(q) {
      const url = `/.netlify/functions/news?q=${encodeURIComponent(q)}`;
      const r = await fetch(url, { credentials: 'same-origin' });
      if (!r.ok) {
        const txt = await r.text().catch(()=>"");
        throw new Error(`Backend ${r.status}: ${txt}`);
      }
      return await r.json();
    }

    async function fetchCached(q) {
      const key = 'news_' + encodeURIComponent(q||'general');
      const cached = cacheGet(key);
      if (cached) return cached;
      const data = await fetchFromServer(q);
      cacheSet(key, data, CLIENT_CACHE_TTL);
      return data;
    }

    /********** RENDER **********/
    function renderArticles(articles) {
      list.innerHTML = "";
      if (!articles || articles.length === 0) {
        status.textContent = "No hay resultados.";
        info.textContent = "0 resultados";
        return;
      }
      status.textContent = "";
      info.textContent = `Mostrando ${articles.length} noticias`;
      articles.forEach(a => {
        const el = document.createElement("div");
        el.className = "card";
        el.innerHTML = `
          ${a.image ? `<img src="${a.image}" alt="">` : ""}
          <div class="title"><a href="${a.url}" target="_blank" rel="noopener noreferrer">${a.title}</a></div>
          <div class="meta">${a.source?.name || ""} ¬∑ ${a.publishedAt ? new Date(a.publishedAt).toLocaleString() : ""}</div>
          <div>${a.description || ""}</div>
        `;
        list.appendChild(el);
      });
    }

    /********** LOAD (debounced) **********/
    async function load(q = "general") {
      status.textContent = "Cargando...";
      info.textContent = "";
      list.innerHTML = "";
      try {
        const data = await fetchCached(q);
        renderArticles(data.articles || []);
      } catch (err) {
        console.error(err);
        status.textContent = "Error cargando noticias.";
        info.textContent = "‚Äî";
      }
    }

    const debouncedLoad = debounce(q => load(q), DEBOUNCE_MS);

    btnBuscar.onclick = () => {
      const val = qInput.value.trim();
      // if user typed category label in Spanish, map back to key if possible
      const lower = val.toLowerCase();
      const foundKey = Object.keys(CAT_LABELS).find(k => CAT_LABELS[k].toLowerCase() === lower);
      debouncedLoad(foundKey || val || "general");
    };

    qInput.addEventListener('keydown', e => { if (e.key === 'Enter') {
      btnBuscar.click();
    }});
    qInput.addEventListener('input', e => {
      // live suggestions shouldn't trigger server flood; debounce handles it
      // don't auto-search on input to avoid unwanted requests, but allow manual search
    });

    // inicial: marcar active y cargar general
    document.querySelectorAll('.cats button').forEach(b => {
      if (b.dataset.cat === activeCat) b.classList.add('cat-active');
    });
    load(activeCat);
  </script>
</body>
</html>