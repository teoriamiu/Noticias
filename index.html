<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Diario Noticias — Todo en Español</title>

  <meta name="description" content="Sitio moderno con noticias actualizadas en español." />
  <meta name="keywords" content="Diario Noticias" />
  <meta name="author" content="Agustín Díaz" />
  <meta name="robots" content="index, follow" />

  <style>
    :root { --g: 12px; }
    html,body { margin:0; padding:0; background:#fff; font-family:system-ui; color:#111; }
    body { max-width:980px; margin:auto; padding:24px; }
    h1 { margin:0; font-size:22px; font-weight:600; }
    header { display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px; margin-bottom:18px; }
    input[type="search"]{padding:8px 10px;border:1px solid #ddd;border-radius:8px;font-size:14px;min-width:220px;}
    button{padding:8px 12px;border:0;border-radius:8px;background:#111;color:#fff;cursor:pointer;font-size:14px;}
    .cats{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;}
    .cats button{background:#fafafa;color:#111;border:1px solid #eee;padding:6px 10px;font-size:13px;border-radius:8px;cursor:pointer;}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:var(--g);}
    .card{border:1px solid #eee;border-radius:10px;padding:12px;background:#fff;display:flex;flex-direction:column;gap:8px;}
    .card img{width:100%;height:140px;object-fit:cover;border-radius:6px;}
    .title{font-weight:600;font-size:15px;}
    .meta{font-size:12px;color:#666;}
    #status{margin:14px 0;color:#444;}
    footer{margin-top:20px;font-size:13px;color:#666;}
    .small{font-size:12px;color:#888;}
  </style>
</head>

<body>
  <header>
    <h1>Diario Noticias — Todo en español</h1>

    <div style="display:flex;gap:8px;">
      <input id="q" type="search" placeholder="Buscar..." />
      <button id="btnBuscar">Buscar</button>
    </div>
  </header>

  <div class="cats" id="cats"></div>

  <div id="status">Cargando...</div>

  <main>
    <div id="list" class="grid"></div>
  </main>

  <footer><span id="info">—</span> · <span class="small">Traducciones via MyMemory (gratuito)</span></footer>

  <script>
    /***************************************************************************
     * Configuración
     ***************************************************************************/
    // Categorías internas (API) y sus etiquetas en español (UI)
    const CATEGORIES = [
      { key: "business", label: "Negocios" },
      { key: "entertainment", label: "Entretenimiento" },
      { key: "general", label: "General" },
      { key: "health", label: "Salud" },
      { key: "science", label: "Ciencia" },
      { key: "sports", label: "Deportes" },
      { key: "technology", label: "Tecnología" }
    ];

    // Endpoint de traducción MyMemory
    const MYMEMORY_ENDPOINT = 'https://api.mymemory.translated.net/get';

    // Concurrencia máxima de peticiones de traducción simultáneas
    const TRANSLATE_CONCURRENCY = 6;

    /***************************************************************************
     * Elementos DOM
     ***************************************************************************/
    const qInput = document.getElementById("q");
    const btnBuscar = document.getElementById("btnBuscar");
    const cats = document.getElementById("cats");
    const status = document.getElementById("status");
    const list = document.getElementById("list");
    const info = document.getElementById("info");

    /***************************************************************************
     * Render categorías (en español)
     ***************************************************************************/
    CATEGORIES.forEach(cat => {
      const b = document.createElement("button");
      b.textContent = cat.label;
      b.onclick = () => load(cat.key);
      cats.appendChild(b);
    });

    /***************************************************************************
     * Helpers: Fetch noticias desde tu backend
     * (Se asume que tu función Netlify responde JSON con campo articles[])
     ***************************************************************************/
    async function fetchNews(q) {
      const url = `/.netlify/functions/news?q=${encodeURIComponent(q)}`;
      const r = await fetch(url);
      if (!r.ok) throw new Error("Backend error " + r.status);
      return await r.json();
    }

    /***************************************************************************
     * Traducción con MyMemory
     * - Caché en memoria por sesión
     * - Concurrencia limitada
     ***************************************************************************/
    const translationCache = new Map();

    // Traduce un único texto -> devuelve texto traducido o texto original en fallo
    async function translateText(text, target = 'es') {
      if (!text || typeof text !== 'string' || text.trim() === '') return text;
      const key = text + '||' + target;
      if (translationCache.has(key)) return translationCache.get(key);

      // Construimos la URL (langpair: auto|es para detectar idioma fuente)
      const url = MYMEMORY_ENDPOINT + '?q=' + encodeURIComponent(text) + '&langpair=' + encodeURIComponent('auto|' + target);

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('Traducción fallida ' + res.status);
        const j = await res.json();
        // MyMemory devuelve translatedText en responseData
        const translated = (j && j.responseData && j.responseData.translatedText) ? j.responseData.translatedText : text;
        translationCache.set(key, translated);
        return translated;
      } catch (e) {
        console.warn('Error traduciendo:', e);
        translationCache.set(key, text); // cacheamos original para no reintentar inútilmente
        return text;
      }
    }

    // Traduce múltiples textos con concurrencia limitada
    async function translateMany(texts, target = 'es') {
      // Normalizamos y recogemos únicos para evitar duplicados
      const unique = Array.from(new Set(texts.filter(t => t && t.trim())));
      const results = {};
      // simple pool
      let i = 0;
      const pool = new Array(Math.min(TRANSLATE_CONCURRENCY, unique.length)).fill(0).map(async () => {
        while (i < unique.length) {
          const idx = i++;
          const t = unique[idx];
          const tr = await translateText(t, target).catch(() => t);
          results[t] = tr;
        }
      });
      await Promise.all(pool);
      return results; // mapa original -> traducido
    }

    /***************************************************************************
     * Render de artículos (usa traducciones)
     ***************************************************************************/
    function render(articles) {
      list.innerHTML = "";
      if (!articles || articles.length === 0) {
        status.textContent = "No hay resultados.";
        info.textContent = "0 resultados";
        return;
      }
      status.textContent = "";
      info.textContent = `Mostrando ${articles.length} noticias`;

      // Primero extraemos los textos que queremos traducir (para batch)
      const toTranslate = [];
      articles.forEach(a => {
        if (a.title) toTranslate.push(a.title);
        if (a.description) toTranslate.push(a.description);
        if (a.source && a.source.name) toTranslate.push(a.source.name);
      });

      // Ejecutamos la traducción en background y luego renderizamos
      translateMany(toTranslate, 'es').then(map => {
        list.innerHTML = "";
        articles.forEach(a => {
          const title = a.title ? (map[a.title] || a.title) : '';
          const desc = a.description ? (map[a.description] || a.description) : '';
          const src = (a.source && a.source.name) ? (map[a.source.name] || a.source.name) : '';
          const published = a.publishedAt ? new Date(a.publishedAt).toLocaleString('es-AR') : '';

          const el = document.createElement("div");
          el.className = "card";
          el.innerHTML = `
            ${a.image ? `<img src="${a.image}" alt="">` : ""}
            <div class="title"><a href="${a.url || '#'}" target="_blank" rel="noopener noreferrer">${escapeHtml(title)}</a></div>
            <div class="meta">${escapeHtml(src)} · ${published}</div>
            <div>${escapeHtml(desc)}</div>
          `;
          list.appendChild(el);
        });
      }).catch(err => {
        console.error('Error en traducción batch', err);
        // Si las traducciones fallan, renderizamos original
        articles.forEach(a => {
          const el = document.createElement("div");
          el.className = "card";
          el.innerHTML = `
            ${a.image ? `<img src="${a.image}" alt="">` : ""}
            <div class="title"><a href="${a.url || '#'}" target="_blank" rel="noopener noreferrer">${escapeHtml(a.title || '')}</a></div>
            <div class="meta">${escapeHtml(a.source?.name || '')} · ${a.publishedAt ? new Date(a.publishedAt).toLocaleString('es-AR') : ''}</div>
            <div>${escapeHtml(a.description || '')}</div>
          `;
          list.appendChild(el);
        });
      });
    }

    /***************************************************************************
     * Utilidades
     ***************************************************************************/
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    /***************************************************************************
     * Carga principal
     ***************************************************************************/
    async function load(q = "general") {
      status.textContent = "Cargando...";
      info.textContent = "";
      list.innerHTML = "";

      try {
        const data = await fetchNews(q);
        // Si tu backend devuelve objeto como {articles: [...]}: lo respetamos
        const articles = data.articles || data;
        render(articles);
      } catch (err) {
        console.error(err);
        status.textContent = "Error cargando noticias.";
        info.textContent = "—";
      }
    }

    btnBuscar.onclick = () => load(qInput.value.trim() || "general");
    qInput.onkeydown = (e) => { if (e.key === "Enter") btnBuscar.click(); };

    // Inicio: cargar categoría general
    load("general");
  </script>
</body>

</html>